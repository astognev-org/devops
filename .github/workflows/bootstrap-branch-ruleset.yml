name: Bootstrap branch rules

on:
  workflow_call:
    inputs:
      branch:
        type: string
        default: main
      checks:
        description: 'JSON array of required check names, e.g. ["lint","unit-tests"]'
        type: string
        required: true
    secrets:
      GH_ADMIN_TOKEN:
        required: true

jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Create/Update ruleset
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          BRANCH: ${{ inputs.branch }}
          CHECKS_JSON: ${{ inputs.checks }}
        run: |
          set -euo pipefail

          RULESET_NAME="main-protection"

          RULESET_ID="$(gh api -H "Accept: application/vnd.github+json" \
            /repos/$OWNER/$REPO/rulesets \
            --jq ".[] | select(.name==\"$RULESET_NAME\") | .id" | head -n 1 || true)"

          payload="$(jq -n \
            --arg name "$RULESET_NAME" \
            --arg branch "refs/heads/$BRANCH" \
            --argjson checks "$CHECKS_JSON" \
            '{
              name: $name,
              target: "branch",
              enforcement: "active",
              conditions: { ref_name: { include: [$branch], exclude: [] } },
              rules: [
                { type: "required_linear_history" },
                {
                  type: "required_status_checks",
                  parameters: {
                    strict_required_status_checks_policy: true,
                    required_status_checks: ($checks | map({context: .}))
                  }
                }
              ]
            }'
          )"

          if [[ -n "${RULESET_ID:-}" ]]; then
            echo "Updating ruleset id=$RULESET_ID"
            gh api --method PUT -H "Accept: application/vnd.github+json" \
              /repos/$OWNER/$REPO/rulesets/$RULESET_ID \
              --input <(echo "$payload")
          else
            echo "Creating ruleset"
            gh api --method POST -H "Accept: application/vnd.github+json" \
              /repos/$OWNER/$REPO/rulesets \
              --input <(echo "$payload")
          fi
